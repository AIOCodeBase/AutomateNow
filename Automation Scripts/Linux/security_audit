#!/bin/bash
# basic security audit for system hardening

echo "=== Security Audit Report ==="
echo "Generated on: $(date)"
echo "Hostname: $(hostname)"

echo -e "\n=== User Account Security ==="
# check for users with empty passwords
echo "Users with empty passwords:"
awk -F: '($2 == "") {print $1}' /etc/shadow 2>/dev/null || echo "Unable to check (requires root)"

# check for users with uid 0
echo "Users with UID 0 (root privileges):"
awk -F: '($3 == 0) {print $1}' /etc/passwd

echo -e "\n=== File Permissions Audit ==="
# check for world-writable files
echo "World-writable files in system directories:"
find /etc /bin /sbin /usr/bin /usr/sbin -type f -perm -002 2>/dev/null | head -10

# check for suid files
echo "SUID files:"
find / -type f -perm -4000 2>/dev/null | head -10

echo -e "\n=== Network Security ==="
# check open ports
echo "Open network ports:"
netstat -tuln | grep LISTEN | awk '{print $4}' | sort | uniq

# check for unauthorized ssh keys
echo "SSH authorized keys files:"
find /home -name "authorized_keys" -ls 2>/dev/null

echo -e "\n=== System Updates ==="
# check for available updates
if command -v apt >/dev/null; then
    updates=$(apt list --upgradable 2>/dev/null | wc -l)
    echo "Available package updates: $updates"
elif command -v dnf >/dev/null; then
    updates=$(dnf check-update 2>/dev/null | grep -c "^[a-zA-Z]")
    echo "Available package updates: $updates"
fi

echo -e "\n=== Failed Login Attempts ==="
# check for failed login attempts
grep "Failed password" /var/log/auth.log 2>/dev/null | tail -5 || \
grep "authentication failure" /var/log/secure 2>/dev/null | tail -5 || \
echo "No recent failed login attempts found"

logger "Security audit completed"